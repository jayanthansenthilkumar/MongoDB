<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MongoDB Profile</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="main.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
    <style>
        /* Fullscreen loader styles */
        .fullscreen-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(245, 248, 254, 0.9);
            z-index: 1000;
            transition: opacity 0.5s;
        }
        
        .loader-spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
            margin-bottom: 20px;
        }
        
        .loader-text {
            color: #2c3e50;
            font-size: 18px;
            font-weight: 500;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Make SweetAlert appear above the loader */
        .swal2-container {
            z-index: 2000 !important;
        }
        
        /* User dropdown toggle styling */
        .user-profile {
            position: relative;
            cursor: pointer;
        }
        
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 250px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s ease;
            z-index: 100;
        }
        
        .user-dropdown.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .user-profile.active .user-avatar {
            background-color: #f0f4f8;
        }
        
        /* Profile specific styles */
        .profile-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: #f0f7ff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: #3498db;
            margin-right: 30px;
            position: relative;
            overflow: hidden;
            border: 3px solid #fff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .avatar-upload {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            text-align: center;
            padding: 6px 0;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .profile-avatar:hover .avatar-upload {
            opacity: 1;
        }
        
        .profile-info {
            flex: 1;
        }
        
        .profile-name {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
            color: #333;
        }
        
        .profile-role {
            font-size: 16px;
            color: #6c757d;
            margin-bottom: 15px;
        }
        
        .profile-stats {
            display: flex;
            gap: 20px;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
        }
        
        .stat-icon {
            margin-right: 8px;
            color: #3498db;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .section-title i {
            margin-right: 10px;
            color: #3498db;
            background: #f0f7ff;
            padding: 8px;
            border-radius: 8px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 8px;
        }
        
        .form-control {
            border-radius: 6px;
            border: 1px solid #ddd;
            padding: 10px 15px;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn-primary {
            background-color: #3498db;
            border: none;
            padding: 10px 20px;
            font-weight: 500;
        }
        
        .btn-outline {
            background: white;
            border: 1px solid #ddd;
            color: #555;
            padding: 10px 20px;
            font-weight: 500;
        }
        
        .activity-list {
            margin-top: 20px;
        }
        
        .activity-item {
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-icon {
            background: #f0f7ff;
            color: #3498db;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-title {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .activity-time {
            font-size: 13px;
            color: #6c757d;
        }
        
        .badge-role {
            background-color: #3498db;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .profile-tabs {
            margin-bottom: 30px;
            border-bottom: 1px solid #eee;
        }
        
        .profile-tabs .nav-link {
            border: none;
            border-bottom: 3px solid transparent;
            border-radius: 0;
            color: #555;
            font-weight: 500;
            padding: 10px 20px;
        }
        
        .profile-tabs .nav-link.active {
            color: #3498db;
            border-bottom-color: #3498db;
            background-color: transparent;
        }
        
        .tab-content {
            padding-top: 20px;
        }
        
        .tab-pane {
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="loader" class="fullscreen-loader hidden">
        <div class="loader-spinner"></div>
        <div class="loader-text">Loading profile data...</div>
    </div>

    {% if error %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        {{ error }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}
    
    <div class="dashboard dashboard-visible" id="main-dashboard">
        <aside class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-database logo-icon"></i>
                <h1 class="text-xl font-bold">MongoDB View</h1>
            </div>
            <nav>
                <a href="/" class="nav-link">
                    <i class="fas fa-home mr-2"></i>Dashboard
                </a>
                <a href="/students" class="nav-link">
                    <i class="fas fa-graduation-cap mr-2"></i>Students
                </a>
                <a href="/analytics" class="nav-link">
                    <i class="fas fa-chart-bar mr-2"></i>Analytics
                </a>
                <a href="/settings" class="nav-link">
                    <i class="fas fa-cog mr-2"></i>Settings
                </a>
                <a href="/profile" class="nav-link active">
                    <i class="fas fa-user mr-2"></i>Profile
                </a>
            </nav>
            <div class="sidebar-footer">
                <p class="version">v1.0.0</p>
            </div>
        </aside>

        <main class="main-content">
            <header class="enhanced-header">
                <div class="header-main">
                    <!-- Search moved to the left side -->
                    <div class="search-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="global-search" placeholder="Search...">
                    </div>
                    <div class="header-actions">
                        <span class="date-display">{{ current_date }}</span>
                        <button class="refresh-btn" title="Refresh">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <!-- User profile with improved dropdown menu -->
                        <div class="user-profile" title="Administrator">
                            <div class="user-avatar">
                                <i class="fas fa-user"></i>
                                <span class="status-indicator active"></span>
                            </div>
                            <!-- Improved dropdown menu structure for user details -->
                            <div class="user-dropdown">
                                <div class="user-dropdown-header">
                                    <span class="user-name">{{ username }}</span>
                                    <span class="user-status"><i class="fas fa-circle"></i> Active</span>
                                </div>
                                <div class="user-dropdown-body">
                                    <div class="user-info-item">
                                        <i class="fas fa-id-badge"></i>
                                        <span>Role: {{ role }}</span>
                                    </div>
                                    <div class="user-info-item">
                                        <i class="fas fa-clock"></i>
                                        <span>Session: {{ session_time }}</span>
                                    </div>
                                    <div class="user-info-item">
                                        <i class="fas fa-calendar-alt"></i>
                                        <span>Last login: Today</span>
                                    </div>
                                </div>
                                <div class="user-dropdown-footer">
                                    <button class="logout-btn" onclick="logout()">
                                        <i class="fas fa-sign-out-alt"></i> Logout
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <div class="content-wrapper">
                <div class="welcome-card">
                    <div class="welcome-content">
                        <div class="welcome-icon">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div class="welcome-text">
                            <h2>My Profile</h2>
                            <p>View and manage your account information, activity logs, and preferences.</p>
                        </div>
                    </div>
                    <div class="welcome-actions">
                        <button class="welcome-btn" id="save-profile">
                            <i class="fas fa-save"></i>
                            Save Changes
                        </button>
                        <button class="welcome-btn" id="cancel-changes">
                            <i class="fas fa-undo"></i>
                            Cancel Changes
                        </button>
                    </div>
                </div>

                <div class="profile-container">
                    <div class="profile-header">
                        <div class="profile-avatar">
                            {% if profile_image %}
                                <img src="{{ profile_image }}" alt="{{ username }}" id="profile-image">
                            {% else %}
                                <i class="fas fa-user"></i>
                            {% endif %}
                            <div class="avatar-upload">
                                <i class="fas fa-camera"></i> Change
                                <input type="file" id="avatar-upload-input" style="display: none;" accept="image/*">
                            </div>
                        </div>
                        <div class="profile-info">
                            <h1 class="profile-name">{{ username }} <span class="badge-role">{{ role }}</span></h1>
                            <p class="profile-role">{{ job_title|default('Database Administrator') }}</p>
                            <div class="profile-stats">
                                <div class="stat-item">
                                    <i class="fas fa-calendar-check stat-icon"></i>
                                    <span>Joined {{ join_date|default('January 2023') }}</span>
                                </div>
                                <div class="stat-item">
                                    <i class="fas fa-clock stat-icon"></i>
                                    <span>Last active: {{ last_active|default('Today') }}</span>
                                </div>
                                <div class="stat-item">
                                    <i class="fas fa-database stat-icon"></i>
                                    <span>{{ db_operations|default('152') }} operations</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <ul class="nav nav-tabs profile-tabs" id="profileTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab" aria-controls="info" aria-selected="true">
                                <i class="fas fa-info-circle"></i> Account Info
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="activity-tab" data-bs-toggle="tab" data-bs-target="#activity" type="button" role="tab" aria-controls="activity" aria-selected="false">
                                <i class="fas fa-history"></i> Activity
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button" role="tab" aria-controls="security" aria-selected="false">
                                <i class="fas fa-shield-alt"></i> Security
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="preferences-tab" data-bs-toggle="tab" data-bs-target="#preferences" type="button" role="tab" aria-controls="preferences" aria-selected="false">
                                <i class="fas fa-sliders-h"></i> Preferences
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="profileTabsContent">
                        <!-- Account Info Tab -->
                        <div class="tab-pane fade show active" id="info" role="tabpanel" aria-labelledby="info-tab">
                            <h3 class="section-title"><i class="fas fa-user"></i> Personal Information</h3>
                            <form id="profile-form">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="fullname">Full Name</label>
                                            <input type="text" class="form-control" id="fullname" value="{{ full_name|default(username) }}">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="email">Email Address</label>
                                            <input type="email" class="form-control" id="email" value="{{ email|default('admin@example.com') }}">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="phone">Phone Number</label>
                                            <input type="tel" class="form-control" id="phone" value="{{ phone|default('') }}" placeholder="Optional">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="job-title">Job Title</label>
                                            <input type="text" class="form-control" id="job-title" value="{{ job_title|default('Database Administrator') }}">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="bio">Bio</label>
                                    <textarea class="form-control" id="bio" rows="3" placeholder="Tell us about yourself">{{ bio|default('') }}</textarea>
                                </div>
                                
                                <h3 class="section-title mt-4"><i class="fas fa-building"></i> Organization Information</h3>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="department">Department</label>
                                            <input type="text" class="form-control" id="department" value="{{ department|default('IT') }}">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="location">Location</label>
                                            <input type="text" class="form-control" id="location" value="{{ location|default('') }}" placeholder="Optional">
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Activity Tab -->
                        <div class="tab-pane fade" id="activity" role="tabpanel" aria-labelledby="activity-tab">
                            <h3 class="section-title"><i class="fas fa-history"></i> Recent Activity</h3>
                            
                            <div class="activity-list">
                                {% for activity in activities|default([
                                    {icon: 'fas fa-sign-in-alt', title: 'Logged in to the system', time: 'Today at 9:30 AM'},
                                    {icon: 'fas fa-database', title: 'Created new database backup', time: 'Yesterday at 5:15 PM'},
                                    {icon: 'fas fa-pencil-alt', title: 'Updated user settings', time: 'Jan 15, 2023 at 11:45 AM'},
                                    {icon: 'fas fa-user-plus', title: 'Added new user account', time: 'Jan 12, 2023 at 3:30 PM'},
                                    {icon: 'fas fa-chart-line', title: 'Generated monthly analytics report', time: 'Jan 10, 2023 at 9:15 AM'},
                                    {icon: 'fas fa-server', title: 'System maintenance completed', time: 'Jan 5, 2023 at 7:00 PM'},
                                ]) %}
                                <div class="activity-item">
                                    <div class="activity-icon">
                                        <i class="{{ activity.icon }}"></i>
                                    </div>
                                    <div class="activity-content">
                                        <div class="activity-title">{{ activity.title }}</div>
                                        <div class="activity-time">{{ activity.time }}</div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <div class="d-flex justify-content-center mt-4">
                                <button class="btn btn-outline-secondary" id="load-more-activity">
                                    <i class="fas fa-history"></i> Load More Activity
                                </button>
                            </div>
                        </div>
                        
                        <!-- Security Tab -->
                        <div class="tab-pane fade" id="security" role="tabpanel" aria-labelledby="security-tab">
                            <h3 class="section-title"><i class="fas fa-lock"></i> Password & Security</h3>
                            
                            <form id="security-form">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="current-password">Current Password</label>
                                            <input type="password" class="form-control" id="current-password">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="new-password">New Password</label>
                                            <input type="password" class="form-control" id="new-password">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="confirm-password">Confirm New Password</label>
                                            <input type="password" class="form-control" id="confirm-password">
                                        </div>
                                    </div>
                                </div>
                                
                                <button type="button" class="btn btn-primary" id="change-password-btn">
                                    <i class="fas fa-key"></i> Change Password
                                </button>
                            </form>
                            
                            <h3 class="section-title mt-5"><i class="fas fa-shield-alt"></i> Two-Factor Authentication</h3>
                            
                            <div class="d-flex align-items-center justify-content-between mb-4">
                                <div>
                                    <h5>Enable Two-Factor Authentication</h5>
                                    <p class="text-muted">Add an extra layer of security to your account</p>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="two-factor-toggle" {% if tfa_enabled|default(False) %}checked{% endif %}>
                                </div>
                            </div>
                            
                            <div id="tfa-setup" class="mt-4 {% if not tfa_enabled|default(False) %}d-none{% endif %}">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i> Scan the QR code with your authentication app, then enter the verification code.
                                </div>
                                
                                <div class="d-flex justify-content-center mb-4">
                                    <div class="p-3 border rounded text-center">
                                        <img src="{{ tfa_qr_code|default('/static/placeholder-qr.png') }}" alt="2FA QR Code" class="img-fluid" style="max-width: 200px;">
                                        <p class="mt-2 mb-0 text-muted">Secret Key: {{ tfa_secret|default('ABCDEFGHIJKLMNOP') }}</p>
                                    </div>
                                </div>
                                
                                <div class="row justify-content-center">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="tfa-code">Verification Code</label>
                                            <input type="text" class="form-control" id="tfa-code" placeholder="Enter 6-digit code">
                                        </div>
                                        <button type="button" class="btn btn-primary" id="verify-tfa-btn">Verify & Enable</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Preferences Tab -->
                        <div class="tab-pane fade" id="preferences" role="tabpanel" aria-labelledby="preferences-tab">
                            <h3 class="section-title"><i class="fas fa-palette"></i> Display Preferences</h3>
                            
                            <div class="mb-4">
                                <div class="d-flex align-items-center justify-content-between mb-3">
                                    <div>
                                        <h5>Dark Mode</h5>
                                        <p class="text-muted">Use dark theme throughout the application</p>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="dark-mode-toggle" {% if preferences.dark_mode|default(False) %}checked{% endif %}>
                                    </div>
                                </div>
                                
                                <div class="d-flex align-items-center justify-content-between mb-3">
                                    <div>
                                        <h5>Compact View</h5>
                                        <p class="text-muted">Reduce spacing to show more content</p>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="compact-view-toggle" {% if preferences.compact_view|default(False) %}checked{% endif %}>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <h5>Language</h5>
                                        <select class="form-control" id="language-select">
                                            <option value="en" {% if preferences.language|default('en') == 'en' %}selected{% endif %}>English</option>
                                            <option value="es" {% if preferences.language|default('en') == 'es' %}selected{% endif %}>Spanish</option>
                                            <option value="fr" {% if preferences.language|default('en') == 'fr' %}selected{% endif %}>French</option>
                                            <option value="de" {% if preferences.language|default('en') == 'de' %}selected{% endif %}>German</option>
                                            <option value="zh" {% if preferences.language|default('en') == 'zh' %}selected{% endif %}>Chinese</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <h5>Date Format</h5>
                                        <select class="form-control" id="date-format-select">
                                            <option value="MM/DD/YYYY" {% if preferences.date_format|default('MM/DD/YYYY') == 'MM/DD/YYYY' %}selected{% endif %}>MM/DD/YYYY</option>
                                            <option value="DD/MM/YYYY" {% if preferences.date_format|default('MM/DD/YYYY') == 'DD/MM/YYYY' %}selected{% endif %}>DD/MM/YYYY</option>
                                            <option value="YYYY-MM-DD" {% if preferences.date_format|default('MM/DD/YYYY') == 'YYYY-MM-DD' %}selected{% endif %}>YYYY-MM-DD</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <h3 class="section-title"><i class="fas fa-bell"></i> Notification Preferences</h3>
                            
                            <div class="mb-4">
                                <div class="d-flex align-items-center justify-content-between mb-3">
                                    <div>
                                        <h5>Email Notifications</h5>
                                        <p class="text-muted">Receive important information via email</p>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="email-notification-toggle" {% if preferences.email_notifications|default(True) %}checked{% endif %}>
                                    </div>
                                </div>
                                
                                <div class="d-flex align-items-center justify-content-between mb-3">
                                    <div>
                                        <h5>System Alerts</h5>
                                        <p class="text-muted">Receive system status and alert notifications</p>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="system-alerts-toggle" {% if preferences.system_alerts|default(True) %}checked{% endif %}>
                                    </div>
                                </div>
                                
                                <div class="d-flex align-items-center justify-content-between mb-3">
                                    <div>
                                        <h5>Analytics Reports</h5>
                                        <p class="text-muted">Receive weekly/monthly analytics reports</p>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="analytics-reports-toggle" {% if preferences.analytics_reports|default(True) %}checked{% endif %}>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-end mt-4">
                                <button class="btn btn-primary" id="save-preferences-btn">
                                    <i class="fas fa-save"></i> Save Preferences
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
    <script src="dashboard.js"></script>
    <script>
        function logout() {
            window.location.href = "{{ url_for('logout') }}";
            window.onpageshow = function(event) {
                if (event.persisted) {
                    window.location.reload();
                }
            };
        }
    
        $(document).ready(function() {
            // Display current date in header
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            $('.date-display').text(now.toLocaleDateString('en-US', options));
            
            // User dropdown toggle functionality
            $('.user-profile').off('click').on('click', function(e) {
                e.stopPropagation();
                $(this).toggleClass('active');
                $(this).find('.user-dropdown').toggleClass('visible');
            });
            
            $(document).on('click', function(e) {
                if (!$(e.target).closest('.user-profile').length) {
                    $('.user-profile').removeClass('active');
                    $('.user-dropdown').removeClass('visible');
                }
            });
            
            // Profile image upload functionality
            $('.avatar-upload').on('click', function() {
                $('#avatar-upload-input').click();
            });
            
            $('#avatar-upload-input').on('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        // If profile image exists, update it, otherwise create one
                        if ($('#profile-image').length) {
                            $('#profile-image').attr('src', e.target.result);
                        } else {
                            $('.profile-avatar i').remove();
                            $('<img>', {
                                id: 'profile-image',
                                src: e.target.result,
                                alt: '{{ username }}'
                            }).prependTo('.profile-avatar');
                        }
                        
                        // In a real app, you would upload the image to the server here
                        // For this demo, we just show it in the UI and pretend we'll save it later
                    };
                    
                    reader.readAsDataURL(e.target.files[0]);
                    
                    // Show success message
                    Swal.fire({
                        icon: 'success',
                        title: 'Profile Picture Updated',
                        text: 'Your new profile picture will be saved when you submit your changes.',
                        timer: 3000,
                        showConfirmButton: false
                    });
                }
            });
            
            // Save profile changes
            $('#save-profile, #save-profile-btn').on('click', function() {
                // Show loading indicator
                const loader = document.getElementById('loader');
                loader.classList.remove('hidden');
                
                // Collect form data
                const formData = {
                    fullName: $('#fullname').val(),
                    email: $('#email').val(),
                    phone: $('#phone').val(),
                    jobTitle: $('#job-title').val(),
                    bio: $('#bio').val(),
                    department: $('#department').val(),
                    location: $('#location').val()
                };
                
                // Make AJAX request to save profile data
                $.ajax({
                    url: '/api/profile/update',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function(response) {
                        loader.classList.add('hidden');
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'Profile Updated',
                            text: 'Your profile information has been updated successfully.',
                            timer: 2000,
                            showConfirmButton: false
                        });
                    },
                    error: function(xhr) {
                        loader.classList.add('hidden');
                        
                        let errorMsg = 'Failed to update profile';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMsg = xhr.responseJSON.message;
                        }
                        
                        Swal.fire({
                            icon: 'error',
                            title: 'Update Failed',
                            text: errorMsg
                        });
                    }
                });
            });
            
            // Cancel profile changes
            $('#cancel-changes').on('click', function() {
                Swal.fire({
                    title: 'Discard Changes?',
                    text: 'Any unsaved changes will be lost.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Discard',
                    cancelButtonText: 'Keep Editing'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Reload the page to reset form values
                        window.location.reload();
                    }
                });
            });
            
            // Change password
            $('#change-password-btn').on('click', function() {
                const currentPassword = $('#current-password').val();
                const newPassword = $('#new-password').val();
                const confirmPassword = $('#confirm-password').val();
                
                // Validate input
                if (!currentPassword || !newPassword || !confirmPassword) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Missing Information',
                        text: 'Please fill in all password fields.'
                    });
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Passwords Don\'t Match',
                        text: 'New password and confirmation do not match.'
                    });
                    return;
                }
                
                // Show loading indicator
                const loader = document.getElementById('loader');
                loader.classList.remove('hidden');
                
                // Make AJAX request to change password
                $.ajax({
                    url: '/api/change-password',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    }),
                    success: function(response) {
                        loader.classList.add('hidden');
                        
                        // Clear password fields
                        $('#current-password, #new-password, #confirm-password').val('');
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'Password Changed',
                            text: 'Your password has been updated successfully.'
                        });
                    },
                    error: function(xhr) {
                        loader.classList.add('hidden');
                        
                        let errorMsg = 'Failed to change password';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMsg = xhr.responseJSON.message;
                        }
                        
                        Swal.fire({
                            icon: 'error',
                            title: 'Password Change Failed',
                            text: errorMsg
                        });
                    }
                });
            });
            
            // Toggle two-factor authentication
            $('#two-factor-toggle').on('change', function() {
                const isEnabled = $(this).is(':checked');
                
                if (isEnabled) {
                    // Show TFA setup section
                    $('#tfa-setup').removeClass('d-none');
                    
                    // In a real app, you would make an API call to generate and get a QR code
                    $.ajax({
                        url: '/api/generate-tfa',
                        method: 'GET',
                        success: function(response) {
                            if (response.qrCode) {
                                // Update QR code image and secret
                                // $('#tfa-qr-code').attr('src', response.qrCode);
                                // $('#tfa-secret').text(response.secret);
                            }
                        }
                    });
                } else {
                    // Hide TFA setup section
                    $('#tfa-setup').addClass('d-none');
                    
                    // In a real app, you would make an API call to disable TFA
                    $.ajax({
                        url: '/api/disable-tfa',
                        method: 'POST',
                        success: function(response) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Two-Factor Authentication Disabled',
                                text: 'Two-factor authentication has been turned off.',
                                timer: 2000,
                                showConfirmButton: false
                            });
                        }
                    });
                }
            });
            
            // Verify TFA code
            $('#verify-tfa-btn').on('click', function() {
                const code = $('#tfa-code').val();
                
                if (!code) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Missing Code',
                        text: 'Please enter the verification code from your authenticator app.'
                    });
                    return;
                }
                
                // Show loading indicator
                const loader = document.getElementById('loader');
                loader.classList.remove('hidden');
                
                // Make AJAX request to verify TFA code
                $.ajax({
                    url: '/api/verify-tfa',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ code: code }),
                    success: function(response) {
                        loader.classList.add('hidden');
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'Two-Factor Authentication Enabled',
                            text: 'Two-factor authentication has been successfully set up for your account.'
                        });
                        
                        // Clear the code field
                        $('#tfa-code').val('');
                    },
                    error: function(xhr) {
                        loader.classList.add('hidden');
                        
                        let errorMsg = 'Failed to verify code';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMsg = xhr.responseJSON.message;
                        }
                        
                        Swal.fire({
                            icon: 'error',
                            title: 'Verification Failed',
                            text: errorMsg
                        });
                    }
                });
            });
            
            // Save preferences
            $('#save-preferences-btn').on('click', function() {
                // Show loading indicator
                const loader = document.getElementById('loader');
                loader.classList.remove('hidden');
                
                // Collect preferences data
                const preferencesData = {
                    darkMode: $('#dark-mode-toggle').is(':checked'),
                    compactView: $('#compact-view-toggle').is(':checked'),
                    language: $('#language-select').val(),
                    dateFormat: $('#date-format-select').val(),
                    emailNotifications: $('#email-notification-toggle').is(':checked'),
                    systemAlerts: $('#system-alerts-toggle').is(':checked'),
                    analyticsReports: $('#analytics-reports-toggle').is(':checked')
                };
                
                // Make AJAX request to save preferences
                $.ajax({
                    url: '/api/profile/preferences',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(preferencesData),
                    success: function(response) {
                        loader.classList.add('hidden');
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'Preferences Saved',
                            text: 'Your preferences have been updated successfully.',
                            timer: 2000,
                            showConfirmButton: false
                        });
                        
                        // Apply dark mode if enabled
                        if (preferencesData.darkMode) {
                            $('body').addClass('dark-mode');
                        } else {
                            $('body').removeClass('dark-mode');
                        }
                    },
                    error: function(xhr) {
                        loader.classList.add('hidden');
                        
                        let errorMsg = 'Failed to update preferences';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMsg = xhr.responseJSON.message;
                        }
                        
                        Swal.fire({
                            icon: 'error',
                            title: 'Update Failed',
                            text: errorMsg
                        });
                    }
                });
            });
            
            // Load more activity button
            $('#load-more-activity').on('click', function() {
                const button = $(this);
                const originalText = button.html();
                
                // Show loading state
                button.html('<i class="fas fa-spinner fa-spin"></i> Loading...');
                button.prop('disabled', true);
                
                // Simulate loading more activity
                setTimeout(function() {
                    // Add more activity items
                    const newActivities = [
                        {icon: 'fas fa-key', title: 'Changed password', time: 'Jan 3, 2023 at 2:45 PM'},
                        {icon: 'fas fa-sync', title: 'Synchronized database', time: 'Dec 28, 2022 at 10:30 AM'},
                        {icon: 'fas fa-trash', title: 'Deleted old records', time: 'Dec 20, 2022 at 4:15 PM'}
                    ];
                    
                    // Append new activities to the list
                    newActivities.forEach(activity => {
                        $('.activity-list').append(`
                            <div class="activity-item">
                                <div class="activity-icon">
                                    <i class="${activity.icon}"></i>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-title">${activity.title}</div>
                                    <div class="activity-time">${activity.time}</div>
                                </div>
                            </div>
                        `);
                    });
                    
                    // Restore button state
                    button.html(originalText);
                    button.prop('disabled', false);
                    
                    // Show notification
                    Swal.fire({
                        icon: 'success',
                        title: 'Activity Loaded',
                        text: 'Additional activity records have been loaded.',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }, 1500);
            });
            
            // Refresh button functionality
            $('.refresh-btn').on('click', function() {
                window.location.reload();
            });
        });
    </script>
</body>
</html>
