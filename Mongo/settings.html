<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MongoDB Settings</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="main.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
    <style>
        /* Fullscreen loader styles */
        .fullscreen-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(245, 248, 254, 0.9);
            z-index: 1000;
            transition: opacity 0.5s;
        }
        
        .loader-spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
            margin-bottom: 20px;
        }
        
        .loader-text {
            color: #2c3e50;
            font-size: 18px;
            font-weight: 500;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Make SweetAlert appear above the loader */
        .swal2-container {
            z-index: 2000 !important;
        }
        
        /* Add this to hide the dashboard initially */
        .dashboard-hidden {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        .dashboard-visible {
            visibility: visible;
            opacity: 1;
        }

        /* Settings specific styles */
        .settings-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .settings-section {
            margin-bottom: 35px;
        }
        
        .settings-section:last-child {
            margin-bottom: 0;
        }
        
        .settings-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .settings-icon {
            background: #f0f7ff;
            color: #3498db;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }
        
        .settings-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }
        
        .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f5f5f5;
        }
        
        .settings-row:last-child {
            border-bottom: none;
        }
        
        .setting-label {
            font-weight: 500;
            color: #555;
        }
        
        .setting-description {
            color: #888;
            font-size: 13px;
            margin-top: 3px;
        }
        
        .form-switch .form-check-input {
            width: 3em;
            height: 1.5em;
        }
        
        .settings-btn-group {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .settings-btn {
            padding: 8px 20px;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .settings-btn-save {
            background: #3498db;
            color: white;
            border: none;
        }
        
        .settings-btn-save:hover {
            background: #2980b9;
        }
        
        .settings-btn-reset {
            background: white;
            color: #555;
            border: 1px solid #ddd;
        }
        
        .settings-btn-reset:hover {
            background: #f5f5f5;
        }
        
        .color-swatch {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .color-swatch.active {
            border-color: #3498db;
        }
        
        .color-swatches {
            display: flex;
            gap: 10px;
        }
        
        /* User dropdown toggle styling */
        .user-profile {
            position: relative;
            cursor: pointer;
        }
        
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 250px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s ease;
            z-index: 100;
        }
        
        .user-dropdown.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .user-profile.active .user-avatar {
            background-color: #f0f4f8;
        }
    </style>
</head>
<body>
    <div id="loader" class="fullscreen-loader hidden">
        <div class="loader-spinner"></div>
        <div class="loader-text">Loading settings...</div>
    </div>

    {% if error %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        {{ error }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}
    
    <div class="dashboard dashboard-visible" id="main-dashboard">
        <aside class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-database logo-icon"></i>
                <h1 class="text-xl font-bold">MongoDB View</h1>
            </div>
            <nav>
                <a href="/" class="nav-link">
                    <i class="fas fa-home mr-2"></i>Dashboard
                </a>
                <a href="/students" class="nav-link">
                    <i class="fas fa-graduation-cap mr-2"></i>Students
                </a>
                <a href="/analytics" class="nav-link">
                    <i class="fas fa-chart-bar mr-2"></i>Analytics
                </a>
                <a href="/settings" class="nav-link active">
                    <i class="fas fa-cog mr-2"></i>Settings
                </a>
                <a href="/profile" class="nav-link">
                    <i class="fas fa-user mr-2"></i>Profile
                </a>
            </nav>
            <div class="sidebar-footer">
                <p class="version">v1.0.0</p>
            </div>
        </aside>

        <main class="main-content">
            <header class="enhanced-header">
                <div class="header-main">
                    <!-- Search moved to the left side -->
                    <div class="search-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="global-search" placeholder="Search...">
                    </div>
                    <div class="header-actions">
                        <span class="date-display">{{ current_date }}</span>
                        <button class="refresh-btn" title="Refresh">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <!-- User profile with improved dropdown menu -->
                        <div class="user-profile" title="Administrator">
                            <div class="user-avatar">
                                <i class="fas fa-user"></i>
                                <span class="status-indicator active"></span>
                            </div>
                            <!-- Improved dropdown menu structure for user details -->
                            <div class="user-dropdown">
                                <div class="user-dropdown-header">
                                    <span class="user-name">Administrator</span>
                                    <span class="user-status"><i class="fas fa-circle"></i> Active</span>
                                </div>
                                <div class="user-dropdown-body">
                                    <div class="user-info-item">
                                        <i class="fas fa-id-badge"></i>
                                        <span>Role: Admin</span>
                                    </div>
                                    <div class="user-info-item">
                                        <i class="fas fa-clock"></i>
                                        <span>Session: {{ session_time }}</span>
                                    </div>
                                    <div class="user-info-item">
                                        <i class="fas fa-calendar-alt"></i>
                                        <span>Last login: Today</span>
                                    </div>
                                </div>
                                <div class="user-dropdown-footer">
                                    <button class="logout-btn" onclick="logout()">
                                        <i class="fas fa-sign-out-alt"></i> Logout
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <div class="content-wrapper">
                <div class="welcome-card">
                    <div class="welcome-content">
                        <div class="welcome-icon">
                            <i class="fas fa-cog"></i>
                        </div>
                        <div class="welcome-text">
                            <h2>Settings</h2>
                            <p>Configure your MongoDB View application preferences and options.</p>
                        </div>
                    </div>
                    <div class="welcome-actions">
                        <button class="welcome-btn" id="save-all-settings">
                            <i class="fas fa-save"></i>
                            Save All Changes
                        </button>
                        <button class="welcome-btn" id="reset-all-settings">
                            <i class="fas fa-undo"></i>
                            Reset All Settings
                        </button>
                    </div>
                </div>

                <form id="settings-form">
                    <!-- Application Settings -->
                    <div class="settings-container">
                        <div class="settings-section">
                            <div class="settings-header">
                                <div class="settings-icon">
                                    <i class="fas fa-desktop"></i>
                                </div>
                                <h3 class="settings-title">Application Settings</h3>
                            </div>
                            
                            <div class="settings-row">
                                <div>
                                    <div class="setting-label">Theme</div>
                                    <div class="setting-description">Choose your preferred color theme</div>
                                </div>
                                <div class="color-swatches">
                                    <div class="color-swatch active" style="background-color: #3498db;" data-theme="blue"></div>
                                    <div class="color-swatch" style="background-color: #2ecc71;" data-theme="green"></div>
                                    <div class="color-swatch" style="background-color: #9b59b6;" data-theme="purple"></div>
                                    <div class="color-swatch" style="background-color: #e74c3c;" data-theme="red"></div>
                                    <div class="color-swatch" style="background-color: #34495e;" data-theme="dark"></div>
                                </div>
                            </div>
                            
                            <div class="settings-row">
                                <div>
                                    <div class="setting-label">Sidebar Collapsed</div>
                                    <div class="setting-description">Start with a collapsed sidebar to save space</div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="sidebarCollapsed">
                                </div>
                            </div>
                            
                            <div class="settings-row">
                                <div>
                                    <div class="setting-label">Dark Mode</div>
                                    <div class="setting-description">Enable dark mode for all screens</div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="darkMode">
                                </div>
                            </div>
                            
                            <div class="settings-row">
                                <div>
                                    <div class="setting-label">Font Size</div>
                                    <div class="setting-description">Adjust the application font size</div>
                                </div>
                                <select class="form-select" style="width: auto;" id="fontSize">
                                    <option value="small">Small</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="large">Large</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Database Connection Settings -->
                    <div class="settings-container">
                        <div class="settings-section">
                            <div class="settings-header">
                                <div class="settings-icon">
                                    <i class="fas fa-database"></i>
                                </div>
                                <h3 class="settings-title">Database Connection</h3>
                            </div>
                            
                            <div class="settings-row">
                                <div>
                                    <div class="setting-label">Connection String</div>
                                    <div class="setting-description">Your MongoDB connection string</div>
                                </div>
                                <div style="width: 50%;">
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="connectionString" value="mongodb://localhost:27017/mydb">
                                        <button class="btn btn-outline-secondary" type="button" id="toggleConnectionString">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="settings-row">
                                <div>
                                    <div class="setting-label">Connection Timeout</div>
                                    <div class="setting-description">Timeout in seconds for database connections</div>
                                </div>
                                <input type="number" class="form-control" style="width: 100px;" id="connectionTimeout" value="30">
                            </div>
                            
                            <div class="settings-row">
                                <div>
                                    <div class="setting-label">Enable SSL</div>
                                    <div class="setting-description">Use SSL for database connections</div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enableSSL" checked>
                                </div>
                            </div>
                            
                            <div class="settings-row">
                                <div>
                                    <div class="setting-label">Test Connection</div>
                                    <div class="setting-description">Verify your database connection settings</div>
                                </div>
                                <button type="button" class="btn btn-outline-primary" id="testConnection">
                                    <i class="fas fa-vial"></i> Test Connection
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notification Settings -->
                    <div class="settings-container">
                        <div class="settings-section">
                            <div class="settings-header">
                                <div class="settings-icon">
                                    <i class="fas fa-bell"></i>
                                </div>
                                <h3 class="settings-title">Notifications</h3>
                            </div>
                            
                            <div class="settings-row">
                                <div>
                                    <div class="setting-label">Email Notifications</div>
                                    <div class="setting-description">Receive email notifications for important events</div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="emailNotifications" checked>
                                </div>
                            </div>
                            
                            <div class="settings-row">
                                <div>
                                    <div class="setting-label">Email Address</div>
                                    <div class="setting-description">Address for receiving notifications</div>
                                </div>
                                <input type="email" class="form-control" style="width: 250px;" id="emailAddress" value="admin@example.com">
                            </div>
                            
                            <div class="settings-row">
                                <div>
                                    <div class="setting-label">Alert on Error</div>
                                    <div class="setting-description">Display alerts for database errors</div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="alertOnError" checked>
                                </div>
                            </div>
                            
                            <div class="settings-row">
                                <div>
                                    <div class="setting-label">Notification Sound</div>
                                    <div class="setting-description">Play sound for new notifications</div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="notificationSound">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Data & Analytics Settings -->
                    <div class="settings-container">
                        <div class="settings-section">
                            <div class="settings-header">
                                <div class="settings-icon">
                                    <i class="fas fa-chart-pie"></i>
                                </div>
                                <h3 class="settings-title">Data & Analytics</h3>
                            </div>
                            
                            <div class="settings-row">
                                <div>
                                    <div class="setting-label">Data Refresh Interval</div>
                                    <div class="setting-description">How often to refresh data (in minutes)</div>
                                </div>
                                <select class="form-select" style="width: auto;" id="refreshInterval">
                                    <option value="5">5 minutes</option>
                                    <option value="10" selected>10 minutes</option>
                                    <option value="15">15 minutes</option>
                                    <option value="30">30 minutes</option>
                                    <option value="60">1 hour</option>
                                </select>
                            </div>
                            
                            <div class="settings-row">
                                <div>
                                    <div class="setting-label">Default Chart Type</div>
                                    <div class="setting-description">Preferred chart type for visualizations</div>
                                </div>
                                <select class="form-select" style="width: auto;" id="defaultChartType">
                                    <option value="bar">Bar Chart</option>
                                    <option value="line" selected>Line Chart</option>
                                    <option value="pie">Pie Chart</option>
                                    <option value="area">Area Chart</option>
                                </select>
                            </div>
                            
                            <div class="settings-row">
                                <div>
                                    <div class="setting-label">Show Data Labels</div>
                                    <div class="setting-description">Display values directly on charts</div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="showDataLabels" checked>
                                </div>
                            </div>
                            
                            <div class="settings-row">
                                <div>
                                    <div class="setting-label">Export Format</div>
                                    <div class="setting-description">Default format for data exports</div>
                                </div>
                                <select class="form-select" style="width: auto;" id="exportFormat">
                                    <option value="csv" selected>CSV</option>
                                    <option value="excel">Excel</option>
                                    <option value="pdf">PDF</option>
                                    <option value="json">JSON</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Security Settings -->
                    <div class="settings-container">
                        <div class="settings-section">
                            <div class="settings-header">
                                <div class="settings-icon">
                                    <i class="fas fa-shield-alt"></i>
                                </div>
                                <h3 class="settings-title">Security</h3>
                            </div>
                            
                            <div class="settings-row">
                                <div>
                                    <div class="setting-label">Two-Factor Authentication</div>
                                    <div class="setting-description">Require 2FA for login</div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="twoFactorAuth">
                                </div>
                            </div>
                            
                            <div class="settings-row">
                                <div>
                                    <div class="setting-label">Session Timeout</div>
                                    <div class="setting-description">Minutes until automatic logout</div>
                                </div>
                                <select class="form-select" style="width: auto;" id="sessionTimeout">
                                    <option value="15">15 minutes</option>
                                    <option value="30" selected>30 minutes</option>
                                    <option value="60">1 hour</option>
                                    <option value="120">2 hours</option>
                                </select>
                            </div>
                            
                            <div class="settings-row">
                                <div>
                                    <div class="setting-label">API Access</div>
                                    <div class="setting-description">Enable API access to MongoDB data</div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="apiAccess" checked>
                                </div>
                            </div>
                            
                            <div class="settings-row">
                                <div>
                                    <div class="setting-label">Change Password</div>
                                    <div class="setting-description">Update your account password</div>
                                </div>
                                <button type="button" class="btn btn-outline-primary" id="changePassword">
                                    <i class="fas fa-key"></i> Change Password
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-btn-group">
                        <button type="button" class="settings-btn settings-btn-reset" id="resetSettings">
                            <i class="fas fa-undo"></i> Reset Changes
                        </button>
                        <button type="submit" class="settings-btn settings-btn-save" id="saveSettings">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
    <script src="dashboard.js"></script>
    <script>
        function logout() {
            window.location.href = "{{ url_for('logout') }}";
            window.onpageshow = function(event) {
                if (event.persisted) {
                    window.location.reload();
                }
            };
        }
    
        $(document).ready(function() {
            // Display current date in header
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            $('.date-display').text(now.toLocaleDateString('en-US', options));
            
            // User dropdown toggle functionality
            $('.user-profile').off('click').on('click', function(e) {
                e.stopPropagation();
                $(this).toggleClass('active');
                $(this).find('.user-dropdown').toggleClass('visible');
            });
            
            $(document).on('click', function(e) {
                if (!$(e.target).closest('.user-profile').length) {
                    $('.user-profile').removeClass('active');
                    $('.user-dropdown').removeClass('visible');
                }
            });
            
            // Color swatch selection
            $('.color-swatch').on('click', function() {
                $('.color-swatch').removeClass('active');
                $(this).addClass('active');
                
                // Here you would apply the theme
                const theme = $(this).data('theme');
                console.log('Theme selected:', theme);
                
                // Apply theme to UI
                applyTheme(theme);
            });
            
            // Apply theme function
            function applyTheme(theme) {
                // Add basic theme changes to demonstrate functionality
                let primaryColor;
                switch(theme) {
                    case 'blue': primaryColor = '#3498db'; break;
                    case 'green': primaryColor = '#2ecc71'; break;
                    case 'purple': primaryColor = '#9b59b6'; break;
                    case 'red': primaryColor = '#e74c3c'; break;
                    case 'dark': primaryColor = '#34495e'; break;
                    default: primaryColor = '#3498db';
                }
                
                // Apply theme color to various UI elements
                $('.settings-icon').css('color', primaryColor);
                $('.metric-value').css('color', primaryColor);
                $('.settings-btn-save').css('background', primaryColor);
                $('.color-swatch.active').css('border-color', primaryColor);
            }
            
            // Toggle connection string visibility
            $('#toggleConnectionString').on('click', function() {
                const input = $('#connectionString');
                const icon = $(this).find('i');
                
                if (input.attr('type') === 'password') {
                    input.attr('type', 'text');
                    icon.removeClass('fa-eye').addClass('fa-eye-slash');
                } else {
                    input.attr('type', 'password');
                    icon.removeClass('fa-eye-slash').addClass('fa-eye');
                }
            });
            
            // Test connection button - connect to actual API
            $('#testConnection').on('click', function() {
                const button = $(this);
                const originalText = button.html();
                const connectionString = $('#connectionString').val();
                const timeout = $('#connectionTimeout').val();
                const enableSSL = $('#enableSSL').is(':checked');
                
                // Show loading state
                button.html('<i class="fas fa-spinner fa-spin"></i> Testing...');
                button.prop('disabled', true);
                
                // Make actual API call to test connection
                $.ajax({
                    url: '/api/test-connection',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        connectionString: connectionString,
                        timeout: timeout,
                        ssl: enableSSL
                    }),
                    success: function(response) {
                        Swal.fire({
                            title: 'Connection Successful',
                            text: response.message || 'Successfully connected to the MongoDB database',
                            icon: 'success'
                        });
                    },
                    error: function(xhr) {
                        let errorMsg = 'Failed to connect to the database';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMsg = xhr.responseJSON.message;
                        }
                        
                        Swal.fire({
                            title: 'Connection Failed',
                            text: errorMsg,
                            icon: 'error'
                        });
                    },
                    complete: function() {
                        button.html(originalText);
                        button.prop('disabled', false);
                    }
                });
            });
            
            // Change password button - connect to actual API
            $('#changePassword').on('click', function() {
                Swal.fire({
                    title: 'Change Password',
                    html: `
                        <div class="mb-3">
                            <label class="form-label">Current Password</label>
                            <input type="password" id="currentPassword" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">New Password</label>
                            <input type="password" id="newPassword" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Confirm New Password</label>
                            <input type="password" id="confirmPassword" class="form-control">
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Change Password',
                    showLoaderOnConfirm: true,
                    preConfirm: () => {
                        const current = document.getElementById('currentPassword').value;
                        const newPass = document.getElementById('newPassword').value;
                        const confirm = document.getElementById('confirmPassword').value;
                        
                        if (!current || !newPass || !confirm) {
                            Swal.showValidationMessage('All fields are required');
                            return false;
                        }
                        
                        if (newPass !== confirm) {
                            Swal.showValidationMessage('New passwords do not match');
                            return false;
                        }
                        
                        return { currentPassword: current, newPassword: newPass };
                    },
                    allowOutsideClick: () => !Swal.isLoading()
                }).then((result) => {
                    if (result.isConfirmed && result.value) {
                        // Send password change request to the server
                        $.ajax({
                            url: '/api/change-password',
                            method: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify(result.value),
                            success: function(response) {
                                Swal.fire({
                                    title: 'Password Changed',
                                    text: response.message || 'Your password has been successfully updated',
                                    icon: 'success'
                                });
                            },
                            error: function(xhr) {
                                let errorMsg = 'Failed to change password';
                                if (xhr.responseJSON && xhr.responseJSON.message) {
                                    errorMsg = xhr.responseJSON.message;
                                }
                                
                                Swal.fire({
                                    title: 'Error',
                                    text: errorMsg,
                                    icon: 'error'
                                });
                            }
                        });
                    }
                });
            });
            
            // Save settings to server
            $('#settings-form').on('submit', function(e) {
                e.preventDefault();
                
                const loader = document.getElementById('loader');
                loader.classList.remove('hidden');
                
                // Collect all settings from form
                const settings = {
                    theme: $('.color-swatch.active').data('theme'),
                    sidebarCollapsed: $('#sidebarCollapsed').is(':checked'),
                    darkMode: $('#darkMode').is(':checked'),
                    fontSize: $('#fontSize').val(),
                    connectionTimeout: $('#connectionTimeout').val(),
                    enableSSL: $('#enableSSL').is(':checked'),
                    emailNotifications: $('#emailNotifications').is(':checked'),
                    emailAddress: $('#emailAddress').val(),
                    alertOnError: $('#alertOnError').is(':checked'),
                    notificationSound: $('#notificationSound').is(':checked'),
                    refreshInterval: $('#refreshInterval').val(),
                    defaultChartType: $('#defaultChartType').val(),
                    showDataLabels: $('#showDataLabels').is(':checked'),
                    exportFormat: $('#exportFormat').val(),
                    twoFactorAuth: $('#twoFactorAuth').is(':checked'),
                    sessionTimeout: $('#sessionTimeout').val(),
                    apiAccess: $('#apiAccess').is(':checked')
                };
                
                // Save to both localStorage and send to server
                localStorage.setItem('mongodbViewSettings', JSON.stringify(settings));
                
                // Send to server
                $.ajax({
                    url: '/api/save-settings',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(settings),
                    success: function(response) {
                        loader.classList.add('hidden');
                        
                        Swal.fire({
                            title: 'Settings Saved',
                            text: response.message || 'Your preferences have been updated successfully',
                            icon: 'success'
                        });
                    },
                    error: function(xhr) {
                        loader.classList.add('hidden');
                        
                        let errorMsg = 'Failed to save settings';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMsg = xhr.responseJSON.message;
                        }
                        
                        Swal.fire({
                            title: 'Error',
                            text: errorMsg,
                            icon: 'error'
                        });
                    }
                });
            });
            
            // Reset settings button
            $('#resetSettings').on('click', function() {
                Swal.fire({
                    title: 'Reset Settings?',
                    text: 'This will revert all changes you\'ve made on this page',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Reset',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Reset form to defaults
                        document.getElementById('settings-form').reset();
                        $('.color-swatch').removeClass('active');
                        $('.color-swatch[data-theme="blue"]').addClass('active');
                        
                        // Re-apply default theme
                        applyTheme('blue');
                        
                        Swal.fire(
                            'Reset Complete',
                            'Settings have been reset to their previous values',
                            'success'
                        );
                    }
                });
            });
            
            // Reset all settings button (in welcome card)
            $('#reset-all-settings').on('click', function() {
                Swal.fire({
                    title: 'Reset All Settings?',
                    text: 'This will restore all application settings to their default values',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Reset All',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        const loader = document.getElementById('loader');
                        loader.classList.remove('hidden');
                        
                        // Send reset request to server
                        $.ajax({
                            url: '/api/reset-settings',
                            method: 'POST',
                            success: function(response) {
                                // Reset form elements
                                document.getElementById('settings-form').reset();
                                $('.color-swatch').removeClass('active');
                                $('.color-swatch[data-theme="blue"]').addClass('active');
                                
                                // Re-apply default theme
                                applyTheme('blue');
                                
                                // Clear localStorage settings
                                localStorage.removeItem('mongodbViewSettings');
                                
                                loader.classList.add('hidden');
                                
                                Swal.fire(
                                    'Factory Reset Complete',
                                    response.message || 'All settings have been restored to default values',
                                    'success'
                                );
                            },
                            error: function(xhr) {
                                loader.classList.add('hidden');
                                
                                let errorMsg = 'Failed to reset settings';
                                if (xhr.responseJSON && xhr.responseJSON.message) {
                                    errorMsg = xhr.responseJSON.message;
                                }
                                
                                Swal.fire({
                                    title: 'Error',
                                    text: errorMsg,
                                    icon: 'error'
                                });
                            }
                        });
                    }
                });
            });
            
            // Save all settings button (in welcome card)
            $('#save-all-settings').on('click', function() {
                $('#saveSettings').click();
            });
            
            // Load settings from both localStorage and server
            function loadSettings() {
                // First try to load from localStorage for immediate display
                loadSettingsFromLocalStorage();
                
                // Then fetch from server to ensure data is in sync
                $.ajax({
                    url: '/api/get-settings',
                    method: 'GET',
                    success: function(response) {
                        if (response.success && response.settings) {
                            // Apply server settings which take precedence
                            applySettings(response.settings);
                        }
                    },
                    error: function(xhr) {
                        console.error('Error loading settings from server:', xhr);
                    }
                });
            }
            
            // Function to apply settings to form elements
            function applySettings(settings) {
                if (settings.theme) {
                    $('.color-swatch').removeClass('active');
                    $(`.color-swatch[data-theme="${settings.theme}"]`).addClass('active');
                    applyTheme(settings.theme);
                }
                
                if (settings.sidebarCollapsed !== undefined) 
                    $('#sidebarCollapsed').prop('checked', settings.sidebarCollapsed);
                
                if (settings.darkMode !== undefined) 
                    $('#darkMode').prop('checked', settings.darkMode);
                
                if (settings.fontSize) 
                    $('#fontSize').val(settings.fontSize);
                
                if (settings.connectionTimeout) 
                    $('#connectionTimeout').val(settings.connectionTimeout);
                
                if (settings.enableSSL !== undefined) 
                    $('#enableSSL').prop('checked', settings.enableSSL);
                
                if (settings.emailNotifications !== undefined) 
                    $('#emailNotifications').prop('checked', settings.emailNotifications);
                
                if (settings.emailAddress) 
                    $('#emailAddress').val(settings.emailAddress);
                
                if (settings.alertOnError !== undefined) 
                    $('#alertOnError').prop('checked', settings.alertOnError);
                
                if (settings.notificationSound !== undefined) 
                    $('#notificationSound').prop('checked', settings.notificationSound);
                
                if (settings.refreshInterval) 
                    $('#refreshInterval').val(settings.refreshInterval);
                
                if (settings.defaultChartType) 
                    $('#defaultChartType').val(settings.defaultChartType);
                
                if (settings.showDataLabels !== undefined) 
                    $('#showDataLabels').prop('checked', settings.showDataLabels);
                
                if (settings.exportFormat) 
                    $('#exportFormat').val(settings.exportFormat);
                
                if (settings.twoFactorAuth !== undefined) 
                    $('#twoFactorAuth').prop('checked', settings.twoFactorAuth);
                
                if (settings.sessionTimeout) 
                    $('#sessionTimeout').val(settings.sessionTimeout);
                
                if (settings.apiAccess !== undefined) 
                    $('#apiAccess').prop('checked', settings.apiAccess);
            }
            
            // Function to load settings from localStorage
            function loadSettingsFromLocalStorage() {
                const savedSettings = localStorage.getItem('mongodbViewSettings');
                
                if (savedSettings) {
                    try {
                        const settings = JSON.parse(savedSettings);
                        applySettings(settings);
                        console.log('Settings loaded from localStorage');
                    } catch (e) {
                        console.error('Error loading settings from localStorage:', e);
                    }
                }
            }
            
            // Initialize settings
            loadSettings();
            
            // Add keyboard shortcuts for common actions
            $(document).keydown(function(e) {
                // Ctrl+S to save settings
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    $('#saveSettings').click();
                }
                
                // Escape key to close user dropdown
                if (e.key === 'Escape') {
                    $('.user-profile').removeClass('active');
                    $('.user-dropdown').removeClass('visible');
                }
            });
            
            // Refresh button functionality
            $('.refresh-btn').click(function() {
                window.location.reload();
            });
        });
    </script>
</body>
</html>
